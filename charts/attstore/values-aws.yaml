# AWS values for attstore - AWS Deployment Mode
# This configuration uses AWS managed services (S3 for storage, RDS for database)
# Suitable for production AWS/EKS deployments

replicaCount: 2

image:
  repository: ghcr.io/scribe-security/attstore
  pullPolicy: IfNotPresent
  tag: "1.5.3"

imagePullSecrets: []

# Service account with IRSA annotations for AWS access
serviceAccount:
  create: true
  annotations:
    # IMPORTANT: Set this to your IAM role ARN for IRSA
    # eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/attstore-s3-access"
  name: ""

podAnnotations: {}

podSecurityContext:
  fsGroup: 1000

securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000

service:
  type: ClusterIP
  port: 5003
  targetPort: 5003

# Enable ALB Ingress for AWS
ingress:
  enabled: true
  className: "alb"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    # Certificate ARN for HTTPS
    # alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:REGION:ACCOUNT_ID:certificate/CERT_ID"
    alb.ingress.kubernetes.io/healthcheck-path: /healthz
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '15'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '2'
  hosts:
    - host: attstore.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []  # TLS handled by ALB

resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 250m
    memory: 512Mi

livenessProbe:
  httpGet:
    path: /healthz
    port: 5003
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /healthz
    port: 5003
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Enable autoscaling for AWS
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

nodeSelector: {}
tolerations: []

# Anti-affinity to spread pods across AZs
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - attstore
        topologyKey: topology.kubernetes.io/zone

podDisruptionBudget:
  enabled: true
  minAvailable: 1

config:
  port: 5003
  # IMPORTANT: Set strong secrets via AWS Secrets Manager or external-secrets
  sessionSecret: ""  # Retrieve from AWS Secrets Manager
  jwtSecretKey: ""   # Retrieve from AWS Secrets Manager
  
  admin:
    username: "admin"
    password: ""  # Retrieve from AWS Secrets Manager
    email: "admin@example.com"
  
  syslog:
    facility: "16"
    hostname: "attestation-store"
    appName: "attestation-store"
  
  presignedUrlExpiration: "3600"

# Use AWS S3 for object storage
storage:
  type: CLOUD_STORAGE
  
  fileMount:
    path: /app/storage
    baseUrl: ""
  
  persistence:
    enabled: false  # Not needed with S3
  
  cloudStorage:
    provider: AWS
    
    aws:
      # When using IRSA, credentials are not needed
      # Otherwise, provide via secrets
      accessKeyId: ""
      secretAccessKey: ""
      sessionToken: ""
      region: "us-east-1"  # Set to your AWS region
      bucket: ""  # REQUIRED: Set your S3 bucket name
    
    minio:
      endpoint: ""
      accessKey: ""
      secretKey: ""
      bucket: ""
      secure: "true"

# Use external RDS PostgreSQL
database:
  type: postgresql
  
  sqlite:
    path: /app/instance/attestation_store.db
  
  # Disable bundled PostgreSQL
  postgresql:
    enabled: false
    
    host: ""
    port: 5432
    database: attstoredb
    username: attstoreuser
    password: ""
    
    image:
      repository: postgres
      tag: "15"
      pullPolicy: IfNotPresent
    
    persistence:
      enabled: false
    
    resources: {}
  
  # Enable external RDS database
  externalDatabase:
    enabled: true
    # Provide full connection string OR individual components
    url: ""
    # Individual components (if not using url):
    host: ""  # REQUIRED: RDS endpoint (e.g., mydb.xxxx.us-east-1.rds.amazonaws.com)
    port: 5432
    database: "attstoredb"
    username: "attstoreuser"
    password: ""  # REQUIRED: Retrieve from AWS Secrets Manager
    # For RDS IAM authentication (not yet implemented):
    useIAM: false

# Disable MinIO (using S3 instead)
minio:
  enabled: false
  
  image:
    repository: minio/minio
    tag: latest
    pullPolicy: IfNotPresent
  
  rootUser: minioadmin
  rootPassword: ""
  
  bucket: attstorebucket
  
  service:
    type: ClusterIP
    port: 9000
    consolePort: 9001
  
  persistence:
    enabled: false
  
  resources: {}

# Disable PgBouncer (RDS Proxy can be used instead)
pgbouncer:
  enabled: false
  
  image:
    repository: edoburu/pgbouncer
    tag: latest
    pullPolicy: IfNotPresent
  
  poolMode: transaction
  maxClientConn: 600
  defaultPoolSize: 20
  
  resources: {}
